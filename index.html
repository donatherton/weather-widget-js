<!DOCTYPE HTML>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <title>Weather</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json" />
    <!-- <script src="defaults.js"></script> -->
    <style>
      body, a {
        background-color: #000;
        color: #fff;
        font-size: 90%;
        font-family: sans-serif;line-height: 1.5em;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      table {
        border-spacing: 0;
      }
      td {
        padding: 0 5px;
      }
      #links p {
        display: flex;
        flex-wrap: nowrap;
        flex-direction: row;
        gap: 2em;
      }
    </style>
  </head>

  <body>
    <div id="location">
      <form onsubmit="return searchLocation()">
        <label for="loc">Location search </label><input id="loc" type="text" name="loc">
        <input type="submit" name="submit" value="OK">
      </form>
      <div id="results"></div>
    </div>

    <div id="current"></div>

    <script>
      "use strict";

      function searchLocation() {
        const loc = document.getElementById('loc').value;

        function getLocation(result) {
          const data = JSON.parse(result);
          let placeName;
          document.getElementById('results').innerHTML = '';
          for (let i = 0; i < data.length; i++) {
            if ((placeName = data[i].address.city));
            else if ((placeName = data[i].address.town));
            else if ((placeName = data[i].address.village));
            else placeName = data[i].display_name;
            const placeNames = placeName.split(',');
            placeName = placeNames[0];
            document.getElementById('results').innerHTML +=
              `<p><a href="index.html?lat=${data[i].lat}&lon=${data[i].lon}&place=${placeName}&appid=${appid}">${data[i].display_name}</a></p>`;
          }
        }

        // Why is fetch blocked here, when it's not later?
        //fetch(`https://nominatim.openstreetmap.org/?format=json&addressdetails=1&q=${loc}&limit=5`)
        //  .then(response => response.json())
        //  .then(result => getLocation(result));

        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState === 4 && this.status === 200) {
            const result = this.responseText;
            getLocation(result);
          }
        };
        xhttp.open('GET', `https://nominatim.openstreetmap.org/?format=json&addressdetails=1&q=${loc}&format=json&limit=5`, true);
       xhttp.send();
       return false;
      }
    </script>

    <script src="index.js"></script>

    <div id="links" style="position:relative;">

      <script>
        if ("serviceWorker" in navigator) {
          window.addEventListener("load", function() {
            navigator.serviceWorker
              .register("./serviceWorker.js")
              .then(res => console.log("service worker registered"))
              .catch(err => console.log("service worker not registered", err))
          })
        }
      </script>

    </div>
  </body>
</html>


